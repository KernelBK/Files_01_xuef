Common Lisp 操作符分为三类: 可自定义的函数和宏，以及不能自定义的特殊形式 (special form)。本章将
讲述用函数来扩展 Lisp 的技术。但这里的 “技术” 和通常的含义不太一样。关于这些函数，重要的不是知
道怎样写，而是要知道它们从何而来。编写 Lisp 扩展所使用的技术和你编写其他任何 Lisp 函数所使用的
技术大同小异。编写 Lisp 扩展的难点并不在于代码怎么写，而在于决定写什么。

## 4.1 实用工具的诞生

你一边在编写程序，同时也在为 Lisp 增加那些可以让你程序更容易编写的新操作符。这些新操作符被称为实用工具。

用于收集列表中所有满足条件元素的 remove-if-not 函数，在它成为 Common Lisp 的一部分以前，就被程序员们私下里各自定义了多年。

学习编写实用工具与其说是学习编写的技术，不如说是养成编写实用工具的习惯。 自底向上程序设计意
味着在编写程序的同时，也在设计一门编程语言。为了做好这一点，你必须培养出一种能看出程序中缺少
何种操作符的洞察力。你必须能够在看到一个程序时说, “啊，其实你真正的意思是这个。”

程序设计的入门课程从一开始就教授如何通过这种抽象来减少重复劳动。前几课的内容之一就是: 切忌把
程序的行为写死在代码里面。与其定义两个函数，它们几乎完成相同的工作，但其中只有一两个常量不一
样，不如定义成一个函数然后把那些常量以参数的形式传给它。在 Lisp 里可以走得更远一些，因为我们可
以把整个函数都作为参数传递。

虽然在第一个例子里我们用的是预定义的 mapcan，第二个例子里则写了一个新的实用工具 find2，但它们遵循的基本原则是一样的: 与其将通用的和专用的混在一起，不如定义一个通用的然后把专用的部分作为参数。

## 4.2 投资抽象

如果说简洁是智慧的灵魂，那么它和效率也同是优秀软件的本质特征。编写和维护一个程序的开销与其长
度成正比。 同等条件下，程序越短越好。

把对 Lisp 的扩展看作资本支出并不只是会计上的手段。实用工具可以放在单独的文件里；它们既不会在
我们编写程序时分散我们的精力，也不会在事后我们修改遗留代码时被牵连进去。

然而，作为一项投资，实用工具还是需要额外的关照。尤其要紧的是它们的质量必须过关。由于它们要被
多次使用，所以任何不正确或者低效率之处都将会成倍地偿还。

接下来的章节将介绍几类实用函数。它们远不能涵盖你可以加入到 Lisp 的全部函数类型。然而，这里作
为示例给出的所有实用工具都已经在实践中充分地证明了它们的存在价值。

## 4.3 列表上的操作

列表最初曾是 Lisp 主要的数据结构。

尽管如此，至少在编译期它们还是列表。最专业的程序，在运行期很少使用列表, 相反可能会在编译期生成
宏展开式时大量使用列表。所以尽管列表的角色在现代 Lisp 方言里被淡化了，但是针对列表的各种操作
仍然是 Lisp 程序的重要组成部分。

```lisp
(proclaim ’(inline last1 single append1 conc1 mklist))
(defun last1 (lst)
	(car (last lst)))
(defun single (lst)
	(and (consp lst) (not (cdr lst))))
(defun append1 (lst obj)
	(append lst (list obj)))
(defun conc1 (lst obj)
	(nconc lst (list obj)))
(defun mklist (obj)
	(if (listp obj) obj (list obj)))
图 4.1: 操作列表的一些小函数
```



```lisp
(defun longer (x y)
	(labels ((compare (x y)
				(and (consp x)
					(or (null y)
						(compare (cdr x) (cdr y))))))
  (if (and (listp x) (listp y))
      (compare x y)
      (> (length x) (length y)))))
```

