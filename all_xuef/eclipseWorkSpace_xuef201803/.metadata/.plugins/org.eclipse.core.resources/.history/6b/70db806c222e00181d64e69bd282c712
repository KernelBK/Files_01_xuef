package com.xuef2018.bookstore.servlet;

import java.util.Map;

import org.apache.struts2.interceptor.RequestAware;
import org.apache.struts2.interceptor.SessionAware;

import com.opensymphony.xwork2.ActionSupport;
import com.xuef2018.bookstore.domain.Book;
import com.xuef2018.bookstore.domain.web.ShoppingCart;
import com.xuef2018.bookstore.domain.web.ShoppingCartItem;
import com.xuef2018.bookstore.service.BookService;

public class BookServlet extends ActionSupport implements RequestAware, SessionAware {
	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
	private BookService bookService;
	public void setBookService(BookService bookService) {
		this.bookService = bookService;
	}
	
	private int id;
	public void setId(int id) {
		this.id = id;
	}
	// 清空购物车
	public String deleteAll(){
		ShoppingCart cart = (ShoppingCart) sessionMap.get("cart");
		cart.clear();
		return "cart";
	}
	// 从购物车删除某条记录
	public String deleteRecord(){
		ShoppingCart cart = (ShoppingCart) sessionMap.get("cart");
		cart.removeItem(id);
		return "cart";
	}
	// 查看购物车
	public String seeCart(){
		ShoppingCart cart = (ShoppingCart) sessionMap.get("cart");
		for(ShoppingCartItem sc:cart.getItems()){
			System.out.println(sc.getBook().getTitle() + "---" + sc.getBookNum());
		}
		sessionMap.put("seeCart", cart.getItems());
		return "cart";
	}
	// 加入购物车
	public String add2cart(){
		// 1. 从session中取出购物车
		ShoppingCart cart = (ShoppingCart) sessionMap.get("cart");
		// 2. 如果购物车为null，new 一个购物车
		if(cart == null){
			cart = new ShoppingCart();
		}
		// 3. 把书加入购物车
		Book book = bookService.getBook(id);
		cart.addBook(book);
		requestMap.put("newBook", book);
		// 4. 把购物车加入session中
		sessionMap.put("cart", cart);
		return "books-list";
	}
	// 查看图书
	public String detail(){
		requestMap.put("book", bookService.getBook(id));
		return "book-detail";
	}
	private String pageNo;
	private String minPrice;
	private String maxPrice;
	private int page_no = 1;
	private float min_price = 0;
	private float max_price = Integer.MAX_VALUE;
	public void setPageNo(String pageNo) {
		this.pageNo = pageNo;
	}
	public void setMinPrice(String minPrice) {
		this.minPrice = minPrice;
	}
	public void setMaxPrice(String maxPrice) {
		this.maxPrice = maxPrice;
	}
	private void checkAndInit(){
		if(pageNo != null){
			page_no = Integer.parseInt(pageNo);
		}
		if(minPrice != null){
			min_price = Float.parseFloat(minPrice);
		}
		if(maxPrice != null){
			max_price = Float.parseFloat(maxPrice);
		}
	}
	public String getBooks(){
		System.out.println(requestMap);
		checkAndInit();
		CriteriaBook criteriaBook = new CriteriaBook(min_price, max_price, page_no);
		Page<Book> page = bookService.getPage(criteriaBook);
		System.out.println(page);
		requestMap.put("allbooks", page);
		return "books-list";
	}
	private Map<String, Object> requestMap;
	public void setRequest(Map<String, Object> arg0) {
		requestMap = arg0;
	}
	private Map<String, Object> sessionMap;
	public void setSession(Map<String, Object> arg0) {
		sessionMap = arg0;
	}
}
